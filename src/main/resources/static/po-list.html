<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PO List</title>
  <link rel="stylesheet" href="po.css" />
  <style>
    .container.po-form-container {
      max-width: 1600px;
      width: 99vw;
      margin: 0 auto;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 32px;
      min-height: 75vh;
      margin-top: 10px;
    }
    .po-sidebar {
      min-width: 180px;
      max-width: 220px;
      background: #f4f7fa;
      border-radius: 8px;
      border: 1.5px solid #d0d7de;
      padding: 18px 10px 18px 18px;
      margin-top: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      font-size: 1.04em;
      height: 100%;
    }
    .po-sidebar h3 {
      font-size: 1.08em;
      margin-bottom: 10px;
      color: #1a3a4a;
      font-weight: bold;
    }
    .po-date-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .po-date-list li {
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: 5px;
      cursor: pointer;
      color: #2a4a5a;
      transition: background 0.15s;
    }
    .po-date-list li.active, .po-date-list li:hover {
      background: #e0e7ef;
      color: #0a2233;
      font-weight: bold;
    }
    .po-main-content {
      flex: 1;
      min-width: 0;
    }
    .po-main-content header {
      margin-bottom: 6px;
      margin-top: 0;
    }
    .po-card-list { display: flex; flex-wrap: wrap; gap: 18px; justify-content: flex-start; margin-top: 40px; }
    .po-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 12px 14px 10px 14px;
      min-width: 220px;
      max-width: 260px;
      min-height: 70px;
      max-height: 90px;
      height: 80px;
      cursor: pointer;
      transition: box-shadow 0.2s;
      border: 1.5px solid #35474d;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      position: relative;
      box-sizing: border-box;
      color: #fff !important;
      padding-bottom: 50px;
    }
    .po-card * {
      color: #fff !important;
    }
    .po-card:hover { box-shadow: 0 4px 16px rgba(53,71,77,0.18); background: #f7f9fa; }
    .po-card-customer {
      font-size: 1.13em;
      color: #1a3a4a;
      margin-bottom: 1px;
      font-weight: bold;
      line-height: 1.1;
      text-transform: uppercase;
    }
    .po-card-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      margin-bottom: 0.1px;
      width: 100%;
    }
    .po-card-ccn {
      font-weight: normal;
      color: #35474d;
      font-size: 1em;
      margin-right: 8px;
      text-transform: uppercase;
    }
    .po-card-machine {
      font-size: 0.98em;
      color: #2a4a5a;
      font-weight: 500;
      text-transform: uppercase;
    }
    .po-card-info-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      width: 100%;
      margin-top: 2px;
      margin-bottom: 8px;
      padding-bottom: 6px;
    }
    .po-card-order {
      font-size: 0.97em;
      color: #555;
      font-weight: normal;
      text-transform: uppercase;

      
    }
    .po-card-date {
      color: #888;
      font-size: 0.95em;
      font-style: italic;
      margin-left: 8px;
      text-transform: uppercase;
    }
    .po-filters {
      display: flex;
      flex-direction: row;
      gap: 18px;
      margin: 18px 0 0 0;
      align-items: center;
      flex-wrap: wrap;
    }
    .po-filters label {
      font-weight: 500;
      color: #1a3a4a;
      margin-right: 6px;
    }
    .po-filters select {
      padding: 4px 10px;
      border-radius: 5px;
      border: 1px solid #b0b8be;
      font-size: 1em;
      background: #f7f9fa;
      color: #1a3a4a;
      outline: none;
      min-width: 120px;
    }
    @media (max-width: 900px) {
      .container.po-form-container { flex-direction: column; gap: 0; }
      .po-sidebar { max-width: 100vw; min-width: 0; margin-bottom: 18px; }
      .po-main-content { width: 100vw; }
      .po-filters { flex-direction: column; align-items: flex-start; gap: 10px; }
    }
    @media (max-width: 600px) {
      .container.po-form-container { max-width: 100vw; width: 100vw; }
      .po-card-list { gap: 8px; }
      .po-card { min-width: 98vw; max-width: 98vw; padding: 7px 4px; height: 70px; min-height: 60px; max-height: 90px; }
      .po-card-customer { font-size: 1em; }
      .po-card-ccn { font-size: 0.93em; }
      .po-card-machine { font-size: 0.92em; }
      .po-card-order { font-size: 0.91em; }
      .po-card-date { font-size: 0.89em; }
      .po-card-row, .po-card-info-row { gap: 8px; }
    }
  </style>
</head>
<body>
  <div id="header-include"></div>
  <section class="container po-form-container">
    <div class="po-sidebar">
      <h3>PO Date</h3>
      <ul id="poDateList" class="po-date-list"></ul>
    </div>
    <div class="po-main-content">
      <header>All Purchase Orders</header>
      <div class="po-filters">
        <label for="orderTypeFilter">Order Type</label>
        <select id="orderTypeFilter">
          <option value="ALL">All</option>
          <option value="Inhouse">Inhouse</option>
          <option value="Domestic">Domestic</option>
          <option value="Export">Export</option>
        </select>
        <label for="machineCategoryFilter">Machine Category</label>
        <select id="machineCategoryFilter">
          <option value="ALL">All</option>
        </select>
        <label for="machineNameFilter">Machine Name</label>
        <select id="machineNameFilter">
          <option value="ALL">All</option>
        </select>
      </div>
      <div id="poCardList" class="po-card-list"></div>
    </div>
  </section>
  <div id="footer-include"></div>
  <script>
    // Header/footer includes
    fetch('/fragments/header.html').then(r=>r.text()).then(html=>{
      document.getElementById('header-include').innerHTML = html;
    });
    fetch('/fragments/footer.html').then(r=>r.text()).then(html=>{
      document.getElementById('footer-include').innerHTML = html;
    });
    // Fetch and display PO cards with sidebar filter
    let allPOs = [];
    let currentDateFilter = 'ALL';
    let currentOrderType = 'ALL';
    let currentMachineCategory = 'ALL';
    let currentMachineName = 'ALL';
    async function loadPOCards() {
      try {
        const res = await fetch('/api/po');
        if (!res.ok) {
          const text = await res.text();
          document.getElementById('poCardList').innerHTML = `<div style='color:#e00;font-size:1.1em;'>Error loading PO records.<br>Status: ${res.status}<br>${text}</div>`;
          return;
        }
        let data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          document.getElementById('poCardList').innerHTML = '<div style="color:#888;font-size:1.1em;">No PO records found.</div>';
          document.getElementById('poDateList').innerHTML = '';
          return;
        }
        // Defensive: filter out records with no CCN or timestamp
        data = data.filter(po => po.ccn && po.timestamp);
        // Remove POs whose CCN is in localStorage 'kickoffCompletedCCNs'
        let completed = [];
        try { completed = JSON.parse(localStorage.getItem('kickoffCompletedCCNs') || '[]'); } catch {}
        data = data.filter(po => !completed.includes(po.ccn));
        // Sort by timestamp descending
        data = data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        allPOs = data;
        populateDropdowns();
        renderDateSidebar();
        renderPOCards();
      } catch (err) {
        document.getElementById('poCardList').innerHTML = `<div style='color:#e00;font-size:1.1em;'>Error loading PO records.<br>${err}</div>`;
        document.getElementById('poDateList').innerHTML = '';
      }
    }
    function populateDropdowns() {
      // Machine Category
      const catSet = new Set();
      allPOs.forEach(po => { if (po.machineCategory) catSet.add(po.machineCategory); });
      const catSel = document.getElementById('machineCategoryFilter');
      let catHtml = '<option value="ALL">All</option>';
      Array.from(catSet).sort().forEach(cat => { catHtml += `<option value="${cat}">${cat}</option>`; });
      catSel.innerHTML = catHtml;
      // Machine Name
      const nameSet = new Set();
      allPOs.forEach(po => { if (po.machineName) nameSet.add(po.machineName); });
      const nameSel = document.getElementById('machineNameFilter');
      let nameHtml = '<option value="ALL">All</option>';
      Array.from(nameSet).sort().forEach(name => { nameHtml += `<option value="${name}">${name}</option>`; });
      nameSel.innerHTML = nameHtml;
    }
    function renderDateSidebar() {
      const dateSet = new Set();
      allPOs.forEach(po => {
        if (po.timestamp) dateSet.add(po.timestamp.split('T')[0]);
      });
      const dates = Array.from(dateSet).sort((a, b) => new Date(b) - new Date(a));
      let html = `<li class="${currentDateFilter==='ALL'?'active':''}" onclick="filterByDate('ALL', this)">All</li>`;
      dates.forEach(date => {
        html += `<li class="${currentDateFilter===date?'active':''}" onclick="filterByDate('${date}', this)">${date}</li>`;
      });
      document.getElementById('poDateList').innerHTML = html;
    }
    function renderPOCards() {
      let data = allPOs;
      if (currentDateFilter !== 'ALL') {
        data = data.filter(po => po.timestamp && po.timestamp.split('T')[0] === currentDateFilter);
      }
      if (currentOrderType !== 'ALL') {
        data = data.filter(po => (po.orderType||'').toLowerCase() === currentOrderType.toLowerCase());
      }
      if (currentMachineCategory !== 'ALL') {
        data = data.filter(po => (po.machineCategory||'') === currentMachineCategory);
      }
      if (currentMachineName !== 'ALL') {
        data = data.filter(po => (po.machineName||'') === currentMachineName);
      }
      // Always sort by date descending
      data = data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      const list = document.getElementById('poCardList');
      if (!data.length) {
        list.innerHTML = '<div style="color:#888;font-size:1.1em;">No PO records found for this filter.</div>';
        return;
      }
      list.innerHTML = '';
      data.forEach(po => {
        const card = document.createElement('div');
        card.className = 'po-card';
        // Set card color based on orderType
        let orderType = (po.orderType || '').toLowerCase();
        let bg = '';
        if (orderType === 'export') bg = '#008B8B'; // green
        else if (orderType === 'domestic') bg = '#D2691E'; // yellow
        else if (orderType === 'inhouse') bg = '#778899'; // blue
        if (bg) card.style.background = bg;
        card.innerHTML = `
          <div class='po-card-customer'>${po.customerName || '-'}</div>
          <div class='po-card-row'>
            <span class='po-card-ccn'>${po.ccn || '-'}</span>
            <span class='po-card-machine'>${po.machineCategory || '-'}</span>
          </div>
          <div class='po-card-info-row'>
            <span class='po-card-order'>${po.orderType || '-'}</span>
            <span class='po-card-date'>${po.timestamp ? po.timestamp.split('T')[0] : '-'}</span>
          </div>
        `;
        card.onclick = () => {
          window.location.href = `/kickoff form/kickoff.html?ccn=${encodeURIComponent(po.ccn)}`;
        };
        list.appendChild(card);
      });
    }
    window.filterByDate = function(date, el) {
      currentDateFilter = date;
      renderDateSidebar();
      renderPOCards();
    }
    document.getElementById('orderTypeFilter').addEventListener('change', function() {
      currentOrderType = this.value;
      renderPOCards();
    });
    document.getElementById('machineCategoryFilter').addEventListener('change', function() {
      currentMachineCategory = this.value;
      renderPOCards();
    });
    document.getElementById('machineNameFilter').addEventListener('change', function() {
      currentMachineName = this.value;
      renderPOCards();
    });
    loadPOCards();
  </script>
</body>
</html>
