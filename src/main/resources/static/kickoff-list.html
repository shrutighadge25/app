<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kickoff List</title>
  <link rel="stylesheet" href="kickoff.css" />
  <style>
    body {
      background: #35474d;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      position: relative;
      max-width: 1600px;
      width: 100%;
      background: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      margin-top: 60px;
      margin-bottom: 60px;
    }
    .container.kickoff-form-container {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 32px;
      min-height: 75vh;
      width: 100%;
      background: none;
      box-shadow: none;
      padding: 0;
      margin: 0;
    }
    .kickoff-sidebar {
      min-width: 180px;
      max-width: 220px;
      background: #f4f7fa;
      border-radius: 8px;
      border: 1.5px solid #d0d7de;
      padding: 18px 10px 18px 18px;
      margin-top: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      font-size: 1.04em;
      height: 100%;
    }
    .kickoff-sidebar h3 {
      font-size: 1.08em;
      margin-bottom: 10px;
      color: #1a3a4a;
      font-weight: bold;
    }
    .kickoff-date-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .kickoff-date-list li {
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: 5px;
      cursor: pointer;
      color: #2a4a5a;
      transition: background 0.15s;
    }
    .kickoff-date-list li.active, .kickoff-date-list li:hover {
      background: #e0e7ef;
      color: #0a2233;
      font-weight: bold;
    }
    .kickoff-main-content {
      flex: 1;
      min-width: 0;
    }
    .kickoff-main-content header {
      margin-bottom: 6px;
      margin-top: 0;
    }
    .kickoff-filters {
      display: flex;
      flex-direction: row;
      gap: 18px;
      margin: 18px 0 0 0;
      align-items: center;
      flex-wrap: wrap;
    }
    .kickoff-filters label {
      font-weight: 500;
      color: #1a3a4a;
      margin-right: 6px;
    }
    .kickoff-filters select {
      padding: 4px 10px;
      border-radius: 5px;
      border: 1px solid #b0b8be;
      font-size: 1em;
      background: #f7f9fa;
      color: #1a3a4a;
      outline: none;
      min-width: 120px;
    }
    .kickoff-card-list { display: flex; flex-wrap: wrap; gap: 18px; justify-content: flex-start; margin-top: 40px; }
    .kickoff-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 12px 14px 10px 14px;
      min-width: 220px;
      max-width: 260px;
      min-height: 70px;
      max-height: 110px;
      height: 100px;
      cursor: pointer;
      transition: box-shadow 0.2s;
      border: 1.5px solid #35474d;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      position: relative;
      box-sizing: border-box;
      color: #fff !important;
      padding-bottom: 50px;
    }
    .kickoff-card * {
      color: #fff !important;
    }
    .kickoff-card:hover { box-shadow: 0 4px 16px rgba(53,71,77,0.18); background: #f7f9fa; }
    .kickoff-card-header {
      font-size: 1.13em;
      color: #1a3a4a;
      margin-bottom: 1px;
      font-weight: bold;
      line-height: 1.1;
      text-transform: uppercase;
    }
    .kickoff-card-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      margin-bottom: 0.1px;
      width: 100%;
    }
    .kickoff-card-kom {
      font-weight: normal;
      color: #35474d;
      font-size: 1em;
      margin-right: 8px;
      text-transform: uppercase;
    }
    .kickoff-card-ccn {
      font-size: 0.98em;
      color: #2a4a5a;
      font-weight: 500;
      text-transform: uppercase;
    }
    .kickoff-card-info-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 12px;
      width: 100%;
      margin-top: 2px;
      margin-bottom: 8px;
      padding-bottom: 6px;
    }
    .kickoff-card-model {
      font-size: 0.97em;
      color: #555;
      font-weight: normal;
      text-transform: uppercase;
    }
    .kickoff-card-date {
      color: #888;
      font-size: 0.95em;
      font-style: italic;
      margin-left: 8px;
      text-transform: uppercase;
    }
    @media (max-width: 900px) {
      .container.kickoff-form-container { flex-direction: column; gap: 0; max-width: 100vw; }
      .kickoff-sidebar { max-width: 100vw; min-width: 0; margin-bottom: 18px; }
      .kickoff-main-content { width: 100vw; }
      .kickoff-filters { flex-direction: column; align-items: flex-start; gap: 10px; }
      .kickoff-card-list { gap: 8px; }
      .kickoff-card { min-width: 98vw; max-width: 98vw; padding: 7px 4px; height: 90px; min-height: 60px; max-height: 120px; }
      .kickoff-card-header { font-size: 1em; }
      .kickoff-card-kom { font-size: 0.93em; }
      .kickoff-card-ccn { font-size: 0.92em; }
      .kickoff-card-model { font-size: 0.91em; }
      .kickoff-card-date { font-size: 0.89em; }
      .kickoff-card-row, .kickoff-card-info-row { gap: 8px; }
    }
    @media (max-width: 600px) {
      .container.kickoff-form-container { max-width: 100vw; width: 100vw; }
      .kickoff-card-list { gap: 8px; }
      .kickoff-card { min-width: 98vw; max-width: 98vw; padding: 7px 4px; height: 70px; min-height: 60px; max-height: 90px; }
      .kickoff-card-header { font-size: 1em; }
      .kickoff-card-kom { font-size: 0.93em; }
      .kickoff-card-ccn { font-size: 0.92em; }
      .kickoff-card-model { font-size: 0.91em; }
      .kickoff-card-date { font-size: 0.89em; }
      .kickoff-card-row, .kickoff-card-info-row { gap: 8px; }
    }
  </style>
</head>
<body>
  <div id="header-include"></div>
  <section class="container" style="position:relative; max-width: 1600px; width: 100%; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); margin-top: 60px; margin-bottom: 60px;">
    <div class="kickoff-form-container" style="display: flex; flex-direction: row; align-items: flex-start; gap: 32px; min-height: 75vh; width: 100%; background: none; box-shadow: none; padding: 0; margin: 0;">
      <div class="kickoff-sidebar">
        <h3>KOM Date</h3>
        <ul id="kickoffDateList" class="kickoff-date-list"></ul>
      </div>
      <div class="kickoff-main-content">
        <header>All Kickoff Forms</header>
        <div class="kickoff-filters">
          <label for="orderTypeFilter">Order Type</label>
          <select id="orderTypeFilter">
            <option value="ALL">All</option>
          </select>
          <label for="machineModelFilter">Machine Model</label>
          <select id="machineModelFilter">
            <option value="ALL">All</option>
          </select>
          <label for="machineCategoryFilter">Machine Category</label>
          <select id="machineCategoryFilter">
            <option value="ALL">All</option>
          </select>
        </div>
        <div id="kickoffCardList" class="kickoff-card-list"></div>
      </div>
    </div>
  </section>
  <div id="footer-include"></div>
  <script>
    fetch('/fragments/header.html').then(r=>r.text()).then(html=>{
      document.getElementById('header-include').innerHTML = html;
    });
    fetch('/fragments/footer.html').then(r=>r.text()).then(html=>{
      document.getElementById('footer-include').innerHTML = html;
    });
    let allKickoffs = [];
    let currentDateFilter = 'ALL';
    let currentOrderType = 'ALL';
    let currentMachineModel = 'ALL';
    let currentMachineCategory = 'ALL';
    async function loadKickoffCards() {
      try {
        const res = await fetch('/api/kickoff');
        if (!res.ok) {
          const text = await res.text();
          document.getElementById('kickoffCardList').innerHTML = `<div style='color:#e00;font-size:1.1em;'>Error loading kickoff records.<br>Status: ${res.status}<br>${text}</div>`;
          document.getElementById('kickoffDateList').innerHTML = '';
          return;
        }
        let data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          document.getElementById('kickoffCardList').innerHTML = '<div style="color:#888;font-size:1.1em;">No kickoff records found.</div>';
          document.getElementById('kickoffDateList').innerHTML = '';
          return;
        }
        data = data.filter(k => k.komNo && k.timestamp);
        data = data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        allKickoffs = data;
        populateDropdowns();
        renderDateSidebar();
        renderKickoffCards();
      } catch (err) {
        document.getElementById('kickoffCardList').innerHTML = `<div style='color:#e00;font-size:1.1em;'>Error loading kickoff records.<br>${err}</div>`;
        document.getElementById('kickoffDateList').innerHTML = '';
      }
    }
    function populateDropdowns() {
      // Order Type
      const orderTypeSet = new Set();
      allKickoffs.forEach(k => { if (k.orderType) orderTypeSet.add(k.orderType); });
      const orderTypeSel = document.getElementById('orderTypeFilter');
      let orderTypeHtml = '<option value="ALL">All</option>';
      Array.from(orderTypeSet).sort().forEach(type => { orderTypeHtml += `<option value="${type}">${type}</option>`; });
      orderTypeSel.innerHTML = orderTypeHtml;
      // Machine Model
      const modelSet = new Set();
      allKickoffs.forEach(k => { if (k.machineModel) modelSet.add(k.machineModel); });
      const modelSel = document.getElementById('machineModelFilter');
      let modelHtml = '<option value="ALL">All</option>';
      Array.from(modelSet).sort().forEach(model => { modelHtml += `<option value="${model}">${model}</option>`; });
      modelSel.innerHTML = modelHtml;
      // Machine Category
      const catSet = new Set();
      allKickoffs.forEach(k => { if (k.machineCategory) catSet.add(k.machineCategory); });
      const catSel = document.getElementById('machineCategoryFilter');
      let catHtml = '<option value="ALL">All</option>';
      Array.from(catSet).sort().forEach(cat => { catHtml += `<option value="${cat}">${cat}</option>`; });
      catSel.innerHTML = catHtml;
    }
    function renderDateSidebar() {
      const dateSet = new Set();
      allKickoffs.forEach(k => {
        if (k.timestamp) dateSet.add(k.timestamp.split('T')[0]);
      });
      const dates = Array.from(dateSet).sort((a, b) => new Date(b) - new Date(a));
      let html = `<li class="${currentDateFilter==='ALL'?'active':''}" onclick="filterByDate('ALL', this)">All</li>`;
      dates.forEach(date => {
        html += `<li class="${currentDateFilter===date?'active':''}" onclick="filterByDate('${date}', this)">${date}</li>`;
      });
      document.getElementById('kickoffDateList').innerHTML = html;
    }
    function getModelColor(model) {
      // Assign a color per model (add more as needed)
      const colors = [
        '#008B8B', // teal
        '#D2691E', // chocolate
        '#778899', // slate gray
        '#4682B4', // steel blue
        '#B22222', // firebrick
        '#6A5ACD', // slate blue
        '#228B22', // forest green
        '#FF8C00', // dark orange
        '#8B008B', // dark magenta
        '#2E8B57', // sea green
      ];
      const models = Array.from(new Set(allKickoffs.map(k => k.machineModel).filter(Boolean))).sort();
      const idx = models.indexOf(model);
      return colors[idx % colors.length] || '#35474d';
    }
    function renderKickoffCards() {
      let data = allKickoffs;
      if (currentDateFilter !== 'ALL') {
        data = data.filter(k => k.timestamp && k.timestamp.split('T')[0] === currentDateFilter);
      }
      if (currentOrderType !== 'ALL') {
        data = data.filter(k => (k.orderType||'') === currentOrderType);
      }
      if (currentMachineModel !== 'ALL') {
        data = data.filter(k => (k.machineModel||'') === currentMachineModel);
      }
      if (currentMachineCategory !== 'ALL') {
        data = data.filter(k => (k.machineCategory||'') === currentMachineCategory);
      }
      data = data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      const list = document.getElementById('kickoffCardList');
      if (!data.length) {
        list.innerHTML = '<div style="color:#888;font-size:1.1em;">No kickoff records found for this filter.</div>';
        return;
      }
      list.innerHTML = '';
      data.forEach(k => {
        const card = document.createElement('div');
        card.className = 'kickoff-card';
        card.style.background = getModelColor(k.machineModel);
        card.innerHTML = `
          <div class='kickoff-card-header'>${k.customerName || '-'}</div>
          <div class='kickoff-card-row'>
            <span class='kickoff-card-kom'>${k.komNo || '-'}</span>
            <span class='kickoff-card-ccn'>${k.ccn || '-'}</span>
          </div>
          <div class='kickoff-card-info-row'>
            <span class='kickoff-card-model'>${k.machineModel || '-'}</span>
            <span class='kickoff-card-date'>${k.timestamp ? k.timestamp.split('T')[0] : '-'}</span>
          </div>
        `;
        // On click, open machine.html with ccn as query param
        card.onclick = () => {
          if (k.ccn) {
            window.location.href = `/machine/machine.html?ccn=${encodeURIComponent(k.ccn)}`;
          }
        };
        list.appendChild(card);
      });
    }
    window.filterByDate = function(date, el) {
      currentDateFilter = date;
      renderDateSidebar();
      renderKickoffCards();
    }
    document.getElementById('orderTypeFilter').addEventListener('change', function() {
      currentOrderType = this.value;
      renderKickoffCards();
    });
    document.getElementById('machineModelFilter').addEventListener('change', function() {
      currentMachineModel = this.value;
      renderKickoffCards();
    });
    document.getElementById('machineCategoryFilter').addEventListener('change', function() {
      currentMachineCategory = this.value;
      renderKickoffCards();
    });
    loadKickoffCards();
  </script>
</body>
</html>
