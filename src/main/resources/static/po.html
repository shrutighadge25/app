<!DOCTYPE html>
<!---Coding By CodingLab | www.codinglabweb.com--->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <!--<title>Registration Form in HTML CSS</title>-->
    <!---Custom CSS File--->
    <link rel="stylesheet" href="po.css" />
  </head>
  <body>
    <!-- Header include -->
    <div id="header-include"></div>
    <section class="container po-form-container">
      <header>Purchase Order Form</header>
    
      <form action="#" class="form" id="poForm">
        <div class="input-box">
          <label>Time Stamp</label>
          <input type="datetime-local" id="timestamp" readonly required />
        </div>
        <div class="input-box">
          <label>Record No</label>
          <input type="text" id="recordNo" readonly required />
        </div>
        <div class="input-box">
          <label>CCN</label>
          <input type="text" id="ccnInput" placeholder="Enter CCN" autocomplete="off" required />
          <div id="ccnSuggestions" class="suggestion-box"></div>
        </div>
        <div class="input-box">
          <label>Sales Person</label>
          <input type="text" id="salesPersonInput" placeholder="Enter Sales Person" autocomplete="off" required />
          <div class="dropdown-container" style="position:relative;">
            <select id="salesPersonDropdown" class="dropdown" style="display:none;"></select>
            <button type="button" id="addSalesPersonBtn" style="display:none;margin-top:2px;">Add New</button>
          </div>
        </div>
        <div class="input-box">
          <label>PO Reference Number</label>
          <input type="number" placeholder="Enter PO Reference Number" required />
        </div>
        <div class="input-box">
          <label>PO Date</label>
          <input type="date" placeholder="Enter PO Date" required />
        </div>
        <div class="input-box">
          <label>PO Delivery Date</label>
          <input type="date" placeholder="Enter PO Delivery Date" required />
        </div>
        <div class="input-box">
          <label>PO Value-Lacs</label>
          <input type="number" placeholder="Enter PO Value Lacs" required />
        </div>
        <div class="input-box">
          <label>Customer Name</label>
          <input type="text" id="customerNameInput" placeholder="Enter Customer Name" autocomplete="off" required />
          <div class="dropdown-container" style="position:relative;">
            <select id="customerNameDropdown" class="dropdown" style="display:none;"></select>
            <button type="button" id="addCustomerNameBtn" style="display:none;margin-top:2px;">Add New</button>
          </div>
        </div>
        <div class="input-box">
          <label>Machine Name</label>
          <input type="text" id="machineNameInput" placeholder="Enter Machine Name" autocomplete="off" required />
          <div class="dropdown-container" style="position:relative;">
            <select id="machineNameDropdown" class="dropdown" style="display:none;"></select>
          </div>
        </div>
        <div class="input-box">
          <label>Enter Model</label>
          <input type="text" id="modelNameInput" placeholder="Enter Model" autocomplete="off" required />
          <div class="dropdown-container" style="position:relative;">
            <select id="modelNameDropdown" class="dropdown" style="display:none;"></select>
          </div>
        </div>
        <div class="input-box">
          <label>Machine Category</label>
          <div class="gender-option">
            <div class="gender">
              <input type="radio" id="cat-customized" name="machineCategory" value="customized" checked />
              <label for="cat-customized">Customized</label>
            </div>
            <div class="gender">
              <input type="radio" id="cat-stock" name="machineCategory" value="stock" />
              <label for="cat-stock">Stock</label>
            </div>
            <div class="gender">
              <input type="radio" id="cat-rnd" name="machineCategory" value="rnd" />
              <label for="cat-rnd">R&D</label>
            </div>
            <div class="gender">
              <input type="radio" id="cat-retrofit" name="machineCategory" value="retrofit" />
              <label for="cat-retrofit">Retrofit</label>
            </div>
          </div>
        </div>
        <div class="gender-box">
          <h3>Order Type</h3>
          <div class="gender-option">
            <div class="gender">
              <input type="radio" id="check-inhouse" name="orderType" value="Inhouse" checked />
              <label for="check-inhouse">Inhouse</label>
            </div>
            <div class="gender">
              <input type="radio" id="check-export" name="orderType" value="Export" />
              <label for="check-export">Export</label>
            </div>

            <div class="gender">
              <input type="radio" id="check-domestic" name="orderType" value="Domestic" />
              <label for="check-domestic">Domestic</label>
            </div>
          </div>
        </div>
        <br>
        <div class="input-box address">
          <label>Address</label><br>
          <select id="country"></select>
          <select id="state"></select>
          <select id="city"></select>
          <input type="text" placeholder="Enter Street Address" required />
          <input type="text" placeholder="Enter Street Address line 2" />
        </div>
        <button type="submit">Submit</button>
      </form>
    </section>
    <!-- Footer include -->
    <div id="footer-include"></div>
    <script type="module">
        // --- Address dropdown element variables ---
        const countrySelect = document.getElementById('country');
        const stateSelect = document.getElementById('state');
        const citySelect = document.getElementById('city');
        // --- Auto-generate Time Stamp and Record No ---
        const timestampInput = document.getElementById('timestamp');
        const recordNoInput = document.getElementById('recordNo');
        function pad(n) { return n < 10 ? '0' + n : n; }
        function getCurrentDateTimeLocal() {
          const now = new Date();
          return now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate()) + 'T' + pad(now.getHours()) + ':' + pad(now.getMinutes());
        }
        async function fetchNextRecordNo() {
          try {
            const res = await fetch('/api/po/next-record-no');
            if (res.ok) {
              const text = await res.text();
              recordNoInput.value = text;
            } else {
              recordNoInput.value = 'PO-00-' + new Date().getFullYear();
            }
          } catch {
            recordNoInput.value = 'PO-00-' + new Date().getFullYear();
          }
        }
        timestampInput.value = getCurrentDateTimeLocal();
        fetchNextRecordNo();
     
        // --- Address API logic ---
        import { Country, State, City } from "https://jspm.dev/country-state-city";
        // --- CCN uniqueness check and suggestion logic ---
        const ccnInput = document.getElementById('ccnInput');
        const ccnSuggestions = document.getElementById('ccnSuggestions');
        let ccnValid = true;
        ccnInput.addEventListener('input', async function() {
          const ccn = ccnInput.value.trim();
          if (!ccn) {
            ccnSuggestions.style.display = 'none';
            ccnSuggestions.innerHTML = '';
            ccnInput.setCustomValidity('');
            ccnValid = true;
            return;
          }
          try {
            const res = await fetch(`/api/po/ccn-exists?ccn=${encodeURIComponent(ccn)}`);
            if (res.ok) {
              const data = await res.json();
              if (data.exists) {
                ccnInput.setCustomValidity('This CCN already exists. Please enter a unique CCN.');
                ccnValid = false;
              } else {
                ccnInput.setCustomValidity('');
                ccnValid = true;
              }
              // Show suggestions if any
              if (data.suggestions && data.suggestions.length > 0) {
                ccnSuggestions.innerHTML = `<ul><li class='header'>Similar CCNs:</li>${data.suggestions.map(s => `<li>${s}</li>`).join('')}</ul>`;
                ccnSuggestions.style.display = 'block';
              } else {
                ccnSuggestions.innerHTML = '';
                ccnSuggestions.style.display = 'none';
              }
            }
          } catch {
            ccnInput.setCustomValidity('Error checking CCN uniqueness.');
            ccnValid = false;
            ccnSuggestions.innerHTML = '';
            ccnSuggestions.style.display = 'none';
          }
        });
        // Prevent form submission if CCN is not valid
        document.getElementById('poForm').addEventListener('submit', function(e) {
          if (!ccnValid) {
            ccnInput.reportValidity();
            e.preventDefault();
            return false;
          }
        }, true);
        countrySelect.innerHTML = '<option value="">Select Country</option>';
        Country.getAllCountries().forEach((country) => {
          countrySelect.innerHTML += `<option value="${country.isoCode}">${country.name}</option>`;
        });
        countrySelect.addEventListener("change", function () {
          stateSelect.innerHTML = '<option value="">Select State</option>';
          citySelect.innerHTML = '<option value="">Select City</option>';
          if (this.value) {
            State.getStatesOfCountry(this.value).forEach((state) => {
              stateSelect.innerHTML += `<option value="${state.isoCode}">${state.name}</option>`;
            });
          }
        });
        stateSelect.addEventListener("change", function () {
          citySelect.innerHTML = '<option value="">Select City</option>';
          if (this.value) {
            City.getCitiesOfState(countrySelect.value, this.value).forEach((city) => {
              citySelect.innerHTML += `<option value="${city.name}">${city.name}</option>`;
            });
          }
        });
        // --- Form Submission ---
        document.getElementById('poForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          // Collect all form data and map to backend property names
          const data = {
            recordNo: document.getElementById('recordNo').value,
            timestamp: document.getElementById('timestamp').value,
            ccn: document.getElementById('ccnInput').value,
            salesPerson: document.getElementById('salesPersonInput').value,
            poReferenceNumber: document.querySelector('input[placeholder="Enter PO Reference Number"]').value,
            poDate: document.querySelector('input[placeholder="Enter PO Date"]').value,
            poDeliveryDate: document.querySelector('input[placeholder="Enter PO Delivery Date"]').value,
            poValueLacs: document.querySelector('input[placeholder="Enter PO Value Lacs"]').value,
            customerName: document.getElementById('customerNameInput').value,
            machineName: document.getElementById('machineNameInput').value,
            modelName: document.getElementById('modelNameInput').value,
            machineCategory: document.querySelector('input[name="machineCategory"]:checked').value,
            orderType: document.querySelector('input[name="orderType"]:checked').value,
            country: document.getElementById('country').value,
            state: document.getElementById('state').value,
            city: document.getElementById('city').value,
            addressLine1: document.querySelector('input[placeholder="Enter Street Address"]').value,
            addressLine2: document.querySelector('input[placeholder="Enter Street Address line 2"]').value
          };
          // Convert timestamp to ISO string for backend compatibility
          if (data.timestamp) {
            data.timestamp = new Date(data.timestamp).toISOString();
          }
          try {
            const response = await fetch('/api/po', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(data)
            });
            if (response.ok) {
              alert('Form submitted and saved to database!');
              document.getElementById('poForm').reset();
              timestampInput.value = getCurrentDateTimeLocal();
              await fetchNextRecordNo();
            } else {
              alert('Error submitting form.');
            }
          } catch (err) {
            alert('Error submitting form.');
          }
        });
        // --- Dropdown suggestion and add-new logic for Sales Person, Customer Name ---
        async function fetchSuggestions(field, value) {
          console.log('Fetching suggestions for:', field, 'with query:', value);
          const res = await fetch(`/api/machine-model/suggestions?field=${field}&q=${encodeURIComponent(value)}`);
          if (res.ok) {
            const data = await res.json();
            console.log('Suggestions fetched:', data);
            return data;
          } else {
            console.error('Failed to fetch suggestions:', res.status, res.statusText);
            return [];
          }
        }
        let selectedMachineName = '';
        function setupDropdown(inputId, dropdownId, addBtnId, field) {
  const input = document.getElementById(inputId);
  const dropdown = document.getElementById(dropdownId);
  const addBtn = addBtnId ? document.getElementById(addBtnId) : null;
  let allOptions = [];
  let lastSuggestions = [];

  // Helper to render dropdown with matches on top
  function renderDropdown(matches, rest) {
    dropdown.innerHTML = '';
    matches.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt;
      option.textContent = opt;
      dropdown.appendChild(option);
    });
    rest.forEach(opt => {
      const option = document.createElement('option');
      option.value = opt;
      option.textContent = opt;
      dropdown.appendChild(option);
    });
    dropdown.size = Math.min(dropdown.options.length, 6);
    dropdown.style.display = dropdown.options.length > 0 ? 'block' : 'none';
  }

  // On focus, show all options
  input.addEventListener('focus', async function() {
    if (allOptions.length === 0) {
      allOptions = await fetchSuggestions(field, '');
    }
    renderDropdown(allOptions, []);
    if (addBtn) addBtn.style.display = 'inline-block';
  });

  // On input, show matches on top, rest below
  input.addEventListener('input', async function() {
    const val = input.value.trim();
    if (allOptions.length === 0) {
      allOptions = await fetchSuggestions(field, '');
    }
    if (!val) {
      renderDropdown(allOptions, []);
      if (addBtn) addBtn.style.display = 'inline-block';
      return;
    }
    const matches = allOptions.filter(opt => opt.toLowerCase().includes(val.toLowerCase()));
    const rest = allOptions.filter(opt => !opt.toLowerCase().includes(val.toLowerCase()));
    renderDropdown(matches, rest);
    if (addBtn) addBtn.style.display = matches.includes(val) ? 'none' : 'inline-block';
    if (matches.length > 0) {
      dropdown.selectedIndex = 0;
    }
  });

  // Allow user to select from dropdown (mouse and keyboard)
  dropdown.addEventListener('change', function() {
    input.value = dropdown.value;
    dropdown.style.display = 'none';
    if (addBtn) addBtn.style.display = 'none';
    input.focus();
  });
  dropdown.addEventListener('click', function(e) {
    if (e.target && e.target.tagName === 'OPTION') {
      input.value = e.target.value;
      dropdown.style.display = 'none';
      if (addBtn) addBtn.style.display = 'none';
      input.focus();
    }
  });
  dropdown.addEventListener('mousedown', function(e) {
    e.preventDefault();
    if (dropdown.selectedIndex >= 0) {
      input.value = dropdown.value;
      dropdown.style.display = 'none';
      if (addBtn) addBtn.style.display = 'none';
      input.focus();
    }
  });
  // Keyboard navigation: Enter key to select
  input.addEventListener('keydown', function(e) {
    if (dropdown.style.display === 'block' && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) {
      e.preventDefault();
      if (dropdown.options.length > 0) {
        if (e.key === 'ArrowDown') {
          dropdown.selectedIndex = Math.min(dropdown.selectedIndex + 1, dropdown.options.length - 1);
        } else if (e.key === 'ArrowUp') {
          dropdown.selectedIndex = Math.max(dropdown.selectedIndex - 1, 0);
        }
      }
    } else if (dropdown.style.display === 'block' && e.key === 'Enter') {
      if (dropdown.selectedIndex >= 0) {
        input.value = dropdown.value;
        dropdown.style.display = 'none';
        if (addBtn) addBtn.style.display = 'none';
        e.preventDefault();
      }
    }
  });
  // Hide dropdown/addBtn on blur (with delay for click)
  input.addEventListener('blur', function() {
    setTimeout(()=>{dropdown.style.display='none';if(addBtn) addBtn.style.display='none';}, 200);
  });
  // Add new value logic
  if (addBtn) {
    addBtn.addEventListener('click', async function() {
      const val = input.value.trim();
      if (!val) return;
      const res = await fetch(`/api/po/add-new?field=${field}&value=${encodeURIComponent(val)}`, {method:'POST'});
      if (res.ok) {
        allOptions.push(val);
        renderDropdown([val], allOptions.filter(opt => opt !== val));
        dropdown.selectedIndex = 0;
        input.value = val;
        addBtn.style.display = 'none';
      } else {
        alert('Error adding new value.');
      }
    });
  }
  // For modelNameInput, update dropdown when machineName changes (input, change, blur)
  if (inputId === 'modelNameInput') {
    const machineInput = document.getElementById('machineNameInput');
    async function updateModelDropdown() {
      selectedMachineName = machineInput.value.trim();
      if (selectedMachineName) {
        const res = await fetch(`/api/machine-model/models-by-machine?machineName=${encodeURIComponent(selectedMachineName)}`);
        if (res.ok) {
          allOptions = await res.json();
        } else {
          allOptions = [];
        }
      } else {
        allOptions = await fetchSuggestions(field, '');
      }
      renderDropdown(allOptions, []);
    }
    machineInput.addEventListener('input', updateModelDropdown);
    machineInput.addEventListener('change', updateModelDropdown);
    machineInput.addEventListener('blur', updateModelDropdown);
    // machineInput.addEventListener('click', updateModelDropdown); // Removed to prevent model dropdown opening on machine name click
  }
}
        setupDropdown('salesPersonInput', 'salesPersonDropdown', 'addSalesPersonBtn', 'salesPerson');
        setupDropdown('customerNameInput', 'customerNameDropdown', 'addCustomerNameBtn', 'customerName');
        setupDropdown('machineNameInput', 'machineNameDropdown', null, 'machineName');
        setupDropdown('modelNameInput', 'modelNameDropdown', null, 'machineModel');
      </script>
      <style>
        .dropdown-container {
  position: relative;
  width: 100%;
}
.dropdown-container .dropdown {
  position: absolute;
  left: 0;
  top: 100%;
  width: 100%;
  min-width: 180px;
  max-width: 100%;
  z-index: 20;
  background: #fff;
  border: 1.5px solid#35474d;
  border-radius: 6px;
  font-size: 1em;
  box-shadow: 0 4px 16px rgba(243,121,22,0.13);
  outline: none;
  padding: 0.2em 0;
  margin-top: 2px;
  color: #333;
  transition: border 0.2s;
}
.dropdown-container .dropdown:focus {
  border: 2px solid #35474d;
}
.dropdown-container .dropdown option {
  padding: 8px 12px;
  background: #fff;
  color: #333;
  border-bottom: 1px solid #f3f3f3;
  cursor: pointer;
  transition: background 0.15s;
}
.dropdown-container .dropdown option:hover,
.dropdown-container .dropdown option:checked,
.dropdown-container .dropdown option:focus {
  background: #35474d;
  color: #fff;
}
        .suggestion-box {
          margin-top: 2px;
          background: #f8f8f8;
          border: 1px solid #ccc;
          border-radius: 4px;
          max-width: 300px;
          min-width: 180px;
          display: none;
          position: absolute;
          z-index: 10;
        }
        .suggestion-box ul {
          list-style: none;
          margin: 0;
          padding: 0.5em 0.5em 0.5em 1em;
        }
        .suggestion-box li {
          padding: 2px 0;
          color: #888;
          cursor: not-allowed;
          background: none;
        }
        .suggestion-box li.header {
          font-weight: bold;
          color: #555;
          cursor: default;
        }
        .po-form-container {
      margin-top: 80px; /* space for header */
      margin-bottom: 80px; /* space for footer */
    }
    @media (max-width: 900px) {
      .container {
        max-width: 98vw;
        padding: 10px;
      }
      .po-form-container {
        margin-top: 60px;
        margin-bottom: 60px;
      }
    }
    @media (max-width: 600px) {
      .container {
        max-width: 100vw;
        padding: 2vw;
      }
      .po-form-container {
        margin-top: 52px;
        margin-bottom: 52px;
      }
      .input-box label, .input-box.address label, .gender-box h3 {
        font-size: 0.98rem;
      }
      .form :where(.input-box input, .select-box, .input-box.address select, .input-box.address input[type="text"]) {
        font-size: 0.98rem;
        height: 42px;
        padding: 0 10px;
      }
      .dropdown-container .dropdown {
        font-size: 0.98rem;
      }
    }
      </style>
    <script>
    // Dynamically load header and footer fragments
    fetch('/fragments/header.html').then(r=>r.text()).then(html=>{
      document.getElementById('header-include').innerHTML = html;
    });
    fetch('/fragments/footer.html').then(r=>r.text()).then(html=>{
      document.getElementById('footer-include').innerHTML = html;
    });
  </script>
  </body>
</html>